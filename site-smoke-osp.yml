---
- name: Gather OSP Server facts
  hosts: workstation
  tasks:
    - name: Fetch Instance Info
      os_server_info:
        cloud: openstack
      register: result

    - debug:
        var: result

    - name: Add host
      add_host:
        name: "{{ item.public_v4 }}"
        group: "{{ item.metadata.group }}"
        #ansible_ssh_private_key_file: ~/.ssh/openstack.pem
        #ansible_ssh_user: cloud-user
      with_items: "{{result.openstack_servers}}"

- name: End to end smoke tests
  hosts: apps:appdbs
  gather_facts: true
  become: true
  tags:
    - smoketest  

  tasks:

    - debug:
        msg: 
#          - "IP is {{ hostvars['appdb1']['ansible_default_ipv4']['address'] }}"
          - "First App server  {{ groups.apps[0] }}" 
          - "Second App server {{ groups.apps[1] }}"
          - "Frontend Server {{ groups.frontends[0] }}"
          - "DB Server {{ groups.appdbs[0] }}"
        verbosity: 2        











#- hosts: workstation
#  gather_facts: false
#  tasks:
#  - name: OpenStack servers
#  - name: Curl website

#  - name: Fail if 'Ansible has done its job' is not in the page content
#    fail:
#    when: "'Ansible has done its job' not in webpage.results[0].content"
#    tags:
#      - osp.smoke
